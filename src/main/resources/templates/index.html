<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LOTTO MANAGER - hshim</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-color: #0C2C4D;   /* 로고에 어울리는 네이비 계열 */
            --secondary-color: #D1B174; /* 로고에 어울리는 골드 계열 */
            --background-color: #f9f9f9;
            --text-color: #333;
            --header-height: 60px;
            --transition-speed: 0.2s;
            --border-radius: 4px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding-top: var(--header-height);
        }
        a {
            text-decoration: none;
            color: inherit;
        }
        input, select, textarea, button {
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            padding: 8px;
            transition: border-color var(--transition-speed) ease;
            font: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* 공통 버튼 스타일 */
        .btn {
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #fff;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 600;
        }
        .btn:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        /* 헤더 */
        .header {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: var(--header-height);
            background-color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
        }
        .header-left {
            gap: 10px;
        }
        .site-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            object-fit: cover;
        }
        .header-title {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
        }
        .user-info {
            position: relative;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ccc;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .profile-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-details {
            margin-left: 8px;
        }
        .display-name {
            font-size: 14px;
            font-weight: 600;
        }
        .dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 8px 0;
            display: none;
            flex-direction: column;
            min-width: 90px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dropdown button {
            background: none;
            border: none;
            padding: 8px 16px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        .dropdown button:hover {
            background-color: #f5f5f5;
        }
        .dropdown.open {
            display: flex;
        }

        /* 메인 영역 */
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 16px;
        }
        .main-button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        .main-button {
            display: none;
            border: none;
            border-radius: var(--border-radius);
            padding: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
        }
        .main-button:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
        }
        .main-button:disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .main-button img {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            display: none;
        }
        .main-button.loaded {
            display: flex;
        }
        .main-button.loaded img {
            display: block;
        }

        /* 모달 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 16px;
        }
        .modal-content {
            background-color: #fff;
            position: relative;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 16px;
        }
        .modal-close {
            position: absolute;
            top: 8px; right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        /* 테이블 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            margin-bottom: 16px;
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }
        th {
            background-color: #f7f7f7;
        }
        .memo-cell {
            cursor: pointer;
        }

        /* 버튼 변형 */
        .btn-round-detail {
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-round-detail:hover {
            background-color: #b4965a;
            transform: translateY(-1px);
        }
        .btn-delete {
            background-color: #f44336;
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-delete:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }

        /* Lotto 입력 */
        .lotto-number-input {
            width: 50px;
            padding: 6px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        .btn-plus, .btn-minus {
            color: #fff;
            cursor: pointer;
            padding: 4px 12px;
            font-size: 15px;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-left: 4px;
        }
        .btn-plus {
            background-color: var(--secondary-color);
        }
        .btn-plus:hover {
            background-color: #b4965a;
            transform: translateY(-1px);
        }
        .btn-minus {
            background-color: #f44336;
        }
        .btn-minus:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }
        .disabled-btn {
            background-color: #ccc;
            color: #888;
            cursor: default;
        }
        .dialog-button-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .dialog-button {
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease,
            transform var(--transition-speed) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-cancel {
            background-color: #bbb;
            color: #fff;
        }
        .btn-cancel:hover {
            background-color: #a6a6a6;
            transform: translateY(-1px);
        }
        .btn-submit {
            background-color: var(--secondary-color);
            color: #fff;
        }
        .btn-submit:hover {
            background-color: #b4965a;
            transform: translateY(-1px);
        }
        [id^="numberPopupContainer_"] button.active {
            background-color: #00ab00;
            color: #fff;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .header-title {
                font-size: 14px;
            }
            .main-button {
                padding: 15px;
                font-size: 14px;
            }
            .dialog-button {
                font-size: 12px;
                padding: 8px 12px;
            }
        }

        /* 푸터 */
        .footer-info {
            margin-top: 32px;
            padding: 20px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
        }
        .footer-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .footer-link {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left">
        <!-- 로고 이미지를 /icon/logo.png 등으로 교체 -->
        <img src="/icon/logo.png" alt="LOTTO LOGO" class="site-logo" />
        <span class="header-title" id="headerLeft"></span>
    </div>
    <div class="header-right">
        <div class="user-info" id="user-info">
            <div class="profile-img" id="profile-img">
                <img id="profile-image" src="" alt=""/>
            </div>
            <div class="user-details">
                <div class="display-name" id="display-name"></div>
            </div>
            <div class="dropdown" id="dropdown">
                <button id="my-info">내 정보</button>
                <button id="question">문의</button>
                <button id="notice">공지사항</button>
                <form th:action="@{/logout}" method="post" style="margin: 0;">
                    <button type="submit">로그아웃</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 10px; font-size: 14px; color: #555;">
    매주 토요일 오후 9시 이메일로 결과를 정리하여 보내드립니다
</div>

<div class="container">
    <div class="main-button-grid">
        <button class="main-button" id="btn-game">
            <img id="img-game" src="/icon/main-button/game.png" alt="게임"/>
            <span>게임</span>
        </button>
        <button class="main-button" id="btn-register-numbers">
            <img id="img-register" src="/icon/main-button/register-number.png" alt="번호 등록"/>
            <span>번호 등록</span>
        </button>
        <button class="main-button" id="btn-generate-numbers">
            <img id="img-generate" src="/icon/main-button/random-number.png" alt="번호 생성"/>
            <span>번호 생성</span>
        </button>
        <button class="main-button" id="btn-read-qr">
            <img id="img-readqr" src="/icon/main-button/read-qr.png" alt="QR 인식"/>
            <span>QR 인식</span>
        </button>
    </div>

    <div class="registered-lotto-container" id="registeredLottoContainer"></div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose">X</button>
        <div id="modalBody"></div>
    </div>
</div>

<div class="footer-info">
    <div class="footer-title">문의 및 정보</div>
    <p>이메일 문의: <a href="mailto:hshim.universe@gmail.com" class="footer-link">hshim.universe@gmail.com</a></p>
    <p>인스타그램: <a href="https://instagram.com/hshim__" target="_blank" class="footer-link">@hshim__</a></p>
</div>

<script>
    /* 전역 변수 */
    let latest = 0;
    let algorithms = null;
    let isLoggedIn = false;
    let userId = null;
    let lottoRows = [];
    let camerasList = [];
    let currentCameraIndex = 0;
    let html5QrCodeInstance = null;

    /* 모달 */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalClose = document.getElementById("modalClose");
    const modalBody = document.getElementById("modalBody");

    function openModal() {
        modalOverlay.style.display = "flex";
    }
    function closeModal() {
        if (html5QrCodeInstance) {
            html5QrCodeInstance.stop().then(() => {
                html5QrCodeInstance.clear();
                html5QrCodeInstance = null;
            }).catch((err) => {
                if (err && err.message && err.message.indexOf("not running") !== -1) {
                    html5QrCodeInstance.clear();
                    html5QrCodeInstance = null;
                }
            });
        }
        modalOverlay.style.display = "none";
        modalBody.innerHTML = "";
        document.querySelectorAll("[id^='numberPopupContainer_']").forEach(popup => popup.remove());
    }
    modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });
    modalClose.addEventListener("click", closeModal);

    /* 사용자 드롭다운 */
    const userInfo = document.getElementById("user-info");
    const dropdown = document.getElementById("dropdown");
    const myInfo = document.getElementById("my-info");
    const question = document.getElementById("question");
    const notice = document.getElementById("notice");
    userInfo.addEventListener("click", () => {
        dropdown.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
        if (!userInfo.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.remove("open");
        }
    });
    myInfo.addEventListener("click", () => {
        location.href = "/page/account/user/my-info";
    });
    question.addEventListener("click", () => {
        location.href = "/page/question/list";
    });
    notice.addEventListener("click", () => {
        location.href = "/page/notice/list";
    });

    /* 페이지 로드 */
    window.addEventListener("DOMContentLoaded", async () => {
        await fetchUserInfo();
        fetchCurrentTimes();
        loadRegisteredLottoNumbers();
        document.querySelectorAll(".main-button img").forEach((img) => {
            const showButton = () => img.parentElement.classList.add("loaded");
            if (img.complete) {
                showButton();
            } else {
                img.addEventListener("load", showButton);
                img.addEventListener("error", showButton);
            }
        });
        if (!isLoggedIn) {
            handleNotLoggedInUI();
        }
    });

    async function fetchUserInfo() {
        try {
            const response = await fetch("/api/account/user/my-info");
            if (response.ok) {
                const user = await response.json();
                userId = user.id;
                isLoggedIn = true;
                document.getElementById("display-name").textContent = user.displayName;
                const profileImg = document.getElementById("profile-image");
                if (user.profileUrl) {
                    profileImg.src = user.profileUrl;
                    profileImg.style.backgroundColor = "transparent";
                } else {
                    profileImg.src = "";
                    profileImg.style.backgroundColor = "#ccc";
                    profileImg.removeAttribute("src");
                    profileImg.style.display = "none";
                }
            } else {
                throw new Error();
            }
        } catch (err) {
            isLoggedIn = false;
            setNotLoggedInProfile();
        }
    }
    function setNotLoggedInProfile() {
        const profileImg = document.getElementById("profile-image");
        profileImg.removeAttribute("src");
        profileImg.style.display = "none";
    }
    function handleNotLoggedInUI() {
        const btnGame = document.getElementById("btn-game");
        btnGame.style.backgroundColor = "#ccc";
        btnGame.style.cursor = "default";
        let noticeSpan = document.createElement("span");
        noticeSpan.style.fontSize = "10px";
        noticeSpan.style.display = "block";
        noticeSpan.textContent = "로그인 시 이용 가능";
        btnGame.appendChild(noticeSpan);
        document.getElementById("my-info").classList.add("disabled-btn");
        document.getElementById("question").classList.add("disabled-btn");
        const logoutForm = dropdown.querySelector("form");
        if (logoutForm) {
            logoutForm.remove();
        }
        const loginBtn = document.createElement("button");
        loginBtn.id = "login";
        loginBtn.textContent = "로그인";
        loginBtn.style.cursor = "pointer";
        loginBtn.addEventListener("click", () => {
            location.href = "/login";
        });
        dropdown.appendChild(loginBtn);
    }

    async function fetchCurrentTimes() {
        try {
            const response = await fetch("/api/lotto/times/latest");
            if (!response.ok) throw new Error("회차 정보를 가져오지 못했습니다.");
            const data = await response.json();
            document.getElementById("headerLeft").textContent = `${data.times + 1} 회차 공개예정`;
            latest = data.times + 1;
        } catch (err) {}
    }

    /* 게임 버튼 */
    const btnGame = document.getElementById("btn-game");
    btnGame.addEventListener("click", () => {
        window.location.href = "/page/game/main";
    });

    /* 번호 등록 버튼 */
    const btnRegisterNumbers = document.getElementById("btn-register-numbers");
    btnRegisterNumbers.addEventListener("click", () => {
        handleButtonClick(btnRegisterNumbers, () => {
            openModal();
            showNumberRegisterScreen();
        });
    });

    /* 번호 등록 화면 */
    function showNumberRegisterScreen(initialNumbersList = [], defaultTimes = null) {
        modalBody.innerHTML = `
            <h3>번호 등록</h3>
            <div>
                <label>회차: </label>
                <input type="number" id="timesInput" style="width:120px;" />
            </div>
            <div id="lottoRowsContainer" style="margin:16px 0;"></div>
            <div style="margin:16px 0;">
                <label>메모: </label>
                <input type="text" id="memoInput" style="width:100%;" placeholder="메모를 입력하세요" />
            </div>
        `;
        lottoRows = [];
        if (initialNumbersList.length > 0) {
            initialNumbersList.forEach(numbers => addLottoRow(numbers));
        } else {
            addLottoRow();
        }
        const buttonRow = document.createElement("div");
        buttonRow.className = "dialog-button-row";
        buttonRow.innerHTML = `<button class="dialog-button btn-submit" id="btnSubmitManual">등록</button>`;
        modalBody.appendChild(buttonRow);
        document.getElementById("btnSubmitManual").addEventListener("click", () => {
            if (!isLoggedIn) return;
            handleButtonClick(document.getElementById("btnSubmitManual"), submitManualNumbers);
        });
        modalBody.addEventListener("input", checkAllInputsFilled);
        if (defaultTimes !== null) {
            document.getElementById("timesInput").value = defaultTimes;
        } else {
            document.getElementById("timesInput").value = latest;
        }
        checkAllInputsFilled();
        if (!isLoggedIn) {
            const btnSubmitManual = document.getElementById("btnSubmitManual");
            btnSubmitManual.disabled = true;
            btnSubmitManual.style.backgroundColor = "#ccc";
            btnSubmitManual.style.cursor = "default";
            btnSubmitManual.title = "로그인 후 이용 가능";
        }
    }
    function addLottoRow(preFilledNumbers = []) {
        const container = document.getElementById("lottoRowsContainer");
        const rowIndex = lottoRows.length;
        const rowId = `lottoRow_${rowIndex}`;
        const div = document.createElement("div");
        div.className = "lotto-input-row";
        div.id = rowId;
        let inputHtml = "";
        for (let i = 0; i < 6; i++) {
            const val = preFilledNumbers[i] !== undefined ? preFilledNumbers[i] : "";
            inputHtml += `<input type="number" class="lotto-number-input" value="${val}" />`;
        }
        div.innerHTML = `
            <button class="btn-number-popup" id="btnNumberPopup_${rowIndex}" style="width:40px; height:30px; margin-right:8px; font-size:10px;">선택</button>
            ${inputHtml}
            <button class="btn-plus" id="btnPlus_${rowIndex}">+</button>
            ${rowIndex > 0 ? `<button class="btn-minus" id="btnMinus_${rowIndex}">-</button>` : ""}
        `;
        container.appendChild(div);
        lottoRows.push(rowId);
        document.getElementById(`btnNumberPopup_${rowIndex}`).addEventListener("click", (e) => {
            toggleNumberPopup(e, rowId);
        });
        document.getElementById(`btnPlus_${rowIndex}`).addEventListener("click", () => {
            addLottoRow();
        });
        if (rowIndex > 0) {
            document.getElementById(`btnMinus_${rowIndex}`).addEventListener("click", () => {
                removeLottoRow(rowId);
            });
        }
        checkAllInputsFilled();
    }
    function toggleNumberPopup(event, rowId) {
        const popupId = "numberPopupContainer_" + rowId;
        let popup = document.getElementById(popupId);
        if (!popup) {
            popup = document.createElement("div");
            popup.id = popupId;
            popup.style.position = "absolute";
            const btn = event.target;
            const rect = btn.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 5) + "px";
            popup.style.left = (rect.left + window.scrollX) + "px";
            popup.style.width = "250px";
            popup.style.backgroundColor = "#fff";
            popup.style.border = "1px solid #ccc";
            popup.style.padding = "5px";
            popup.style.display = "grid";
            popup.style.gridTemplateColumns = "repeat(5, 1fr)";
            popup.style.gap = "5px";
            popup.style.zIndex = "1001";
            for (let i = 1; i <= 45; i++) {
                const numBtn = document.createElement("button");
                numBtn.textContent = i;
                numBtn.style.padding = "5px";
                numBtn.style.fontSize = "12px";
                numBtn.style.border = "1px solid #ccc";
                numBtn.style.borderRadius = "4px";
                numBtn.dataset.number = i;
                numBtn.addEventListener("click", function () {
                    const activeCount = popup.querySelectorAll("button.active").length;
                    if (!numBtn.classList.contains("active") && activeCount >= 6) {
                        return;
                    }
                    numBtn.classList.toggle("active");
                    updateRowInput(rowId, popup);
                });
                popup.appendChild(numBtn);
            }
            document.getElementById("modalOverlay").appendChild(popup);
        } else {
            popup.style.display = (popup.style.display === "none" || popup.style.display === "") ? "grid" : "none";
        }
    }
    function updateRowInput(rowId, popup) {
        const activeButtons = popup.querySelectorAll("button.active");
        let selectedNumbers = Array.from(activeButtons).map(btn => parseInt(btn.dataset.number, 10));
        selectedNumbers.sort((a, b) => a - b);
        const rowDiv = document.getElementById(rowId);
        if (rowDiv) {
            const inputs = rowDiv.querySelectorAll(".lotto-number-input");
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].value = selectedNumbers[i] !== undefined ? selectedNumbers[i] : "";
            }
        }
        checkAllInputsFilled();
    }
    (function attachPopupOutsideClickListener() {
        const modalOverlay = document.getElementById("modalOverlay");
        if (!modalOverlay.hasAttribute("data-popup-listener")) {
            modalOverlay.setAttribute("data-popup-listener", "true");
            modalOverlay.addEventListener("click", function (e) {
                const popups = document.querySelectorAll("[id^='numberPopupContainer_']");
                popups.forEach(popup => {
                    if (!popup.contains(e.target) && !e.target.classList.contains("btn-number-popup")) {
                        popup.style.display = "none";
                    }
                });
            });
        }
    })();
    function removeLottoRow(rowId) {
        const div = document.getElementById(rowId);
        if (div) div.remove();
        lottoRows = lottoRows.filter(id => id !== rowId);
        checkAllInputsFilled();
    }
    function checkAllInputsFilled() {
        const timesInput = document.getElementById("timesInput");
        if (!timesInput) return;
        const btnSubmitManual = document.getElementById("btnSubmitManual");
        if (!btnSubmitManual) return;
        if (!isLoggedIn) {
            btnSubmitManual.disabled = true;
            btnSubmitManual.title = "로그인 시 이용 가능";
            return;
        }
        if (!timesInput.value.trim()) {
            btnSubmitManual.disabled = true;
            return;
        }
        const numbersInputs = modalBody.querySelectorAll(".lotto-number-input");
        for (let input of numbersInputs) {
            if (!input.value.trim()) {
                btnSubmitManual.disabled = true;
                return;
            }
        }
        btnSubmitManual.disabled = false;
    }
    function submitManualNumbers() {
        const timesValue = document.getElementById("timesInput").value.trim();
        const memo = document.getElementById("memoInput").value.trim();
        const requestData = [];
        lottoRows.forEach(rowId => {
            const rowDiv = document.getElementById(rowId);
            if (rowDiv) {
                const inputs = rowDiv.querySelectorAll(".lotto-number-input");
                const numbers = [];
                inputs.forEach(inp => {
                    numbers.push(parseInt(inp.value.trim(), 10));
                });
                requestData.push({
                    times: parseInt(timesValue, 10),
                    numbers: numbers,
                    note: memo
                });
            }
        });
        fetch("/api/lotto/numbers", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(requestData),
        })
            .then((res) => {
                if (res.status === 400) {
                    return res.json().then(data => { alert(data.message); });
                } else {
                    alert("등록되었습니다");
                    closeModal();
                    loadRegisteredLottoNumbers();
                }
            })
            .catch((err) => {
                alert("에러가 발생했습니다: " + err.message);
            });
    }

    /* 등록된 로또 번호 목록 */
    const registeredLottoContainer = document.getElementById("registeredLottoContainer");
    function loadRegisteredLottoNumbers() {
        fetch("/api/lotto/numbers", {method: "GET"})
            .then(res => {
                if (!res.ok) throw Error;
                return res.json();
            })
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    registeredLottoContainer.innerHTML = `<p>등록된 로또 번호가 없습니다.</p>`;
                    return;
                }
                renderRegisteredLottoList(data);
            })
            .catch(() => {
                registeredLottoContainer.innerHTML = `<p>로그인 시 등록한 로또번호가 표시됩니다.</p>`;
            });
    }
    function renderRegisteredLottoList(list) {
        const groupedByTimes = {};
        list.forEach(item => {
            const timesKey = item.lotto.times;
            if (!groupedByTimes[timesKey]) {
                groupedByTimes[timesKey] = [];
            }
            groupedByTimes[timesKey].push(item);
        });
        const sortedTimes = Object.keys(groupedByTimes).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
        let html = "";
        sortedTimes.forEach(times => {
            const items = groupedByTimes[times];
            const referenceItem = items[0];
            const lottoInfo = referenceItem.lotto || {};
            const winningNumbersStr = Array.isArray(lottoInfo.numbers) ? lottoInfo.numbers.join(", ") : "";
            const bonusStr = lottoInfo.bonusNumber != null ? ` + ${lottoInfo.bonusNumber}` : "";
            html += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:24px;">
                    <h4 style="margin:0;">
                        ${times} 회차
                        <button class="btn-round-detail"
                            data-lotto='${JSON.stringify(lottoInfo)}'
                            data-rank='${referenceItem.rank}'>상세</button>
                        <span style="margin-left:12px; font-weight:normal; font-size:14px;">
                            ${winningNumbersStr}${bonusStr}
                        </span>
                    </h4>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:200px;">입력번호</th>
                            <th style="width:150px;">메모</th>
                            <th style="width:100px;">등수</th>
                            <th style="width:80px;">삭제</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach(item => {
                let displayRank = item.rank;
                if (item.rank === null || item.rank === undefined) {
                    displayRank = "공개예정";
                } else if (item.rank === 0) {
                    displayRank = "낙첨";
                }
                const deleteButtonHtml = `<button class="btn-delete" data-id="${item.id}">삭제</button>`;
                const inputNumbersHtml = formatNumbers(item.numbers || [], lottoInfo.numbers || []);
                const note = item.note ? item.note : "";
                html += `
                    <tr>
                        <td style="font-family:monospace;">${inputNumbersHtml}</td>
                        <td class="memo-cell" data-id="${item.id}">${note}</td>
                        <td>${displayRank}</td>
                        <td>${deleteButtonHtml}</td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
        });
        if (!list || list.length === 0) {
            html = "<p>등록된 로또 번호가 없습니다.</p>";
        }
        registeredLottoContainer.innerHTML = html;

        const deleteButtons = registeredLottoContainer.querySelectorAll(".btn-delete");
        deleteButtons.forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.getAttribute("data-id");
                if (!confirm("정말 삭제하시겠습니까?")) return;
                try {
                    const response = await fetch(`/api/lotto/number/${id}`, {method: "DELETE"});
                    if (response.ok) {
                        alert("삭제되었습니다.");
                        loadRegisteredLottoNumbers();
                    } else {
                        alert("삭제 실패했습니다.");
                    }
                } catch (err) {
                    alert("에러가 발생했습니다: " + err.message);
                }
            });
        });
        const detailButtons = registeredLottoContainer.querySelectorAll(".btn-round-detail");
        detailButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const lottoStr = btn.getAttribute("data-lotto");
                const rankStr = btn.getAttribute("data-rank");
                if (!lottoStr) return;
                const lottoObj = JSON.parse(lottoStr);
                const rankVal = (rankStr !== "null" && rankStr !== "undefined") ? parseInt(rankStr, 10) : null;
                showRoundDetailDialog(lottoObj, rankVal);
            });
        });
        const memoCells = registeredLottoContainer.querySelectorAll(".memo-cell");
        memoCells.forEach(cell => {
            cell.addEventListener("click", function () {
                if (cell.querySelector("input")) return;
                const originalNote = cell.textContent;
                const id = cell.getAttribute("data-id");
                const input = document.createElement("input");
                input.type = "text";
                input.value = originalNote;
                input.style.width = "100%";
                input.style.boxSizing = "border-box";
                cell.innerHTML = "";
                cell.appendChild(input);
                input.focus();
                input.addEventListener("blur", function () {
                    submitNoteChange(id, input.value, cell, originalNote);
                });
                input.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === "Escape") {
                        cell.textContent = originalNote;
                    }
                });
            });
        });
    }
    async function submitNoteChange(id, newNote, cell, originalNote) {
        if (newNote === originalNote) {
            cell.textContent = originalNote;
            return;
        }
        try {
            const response = await fetch(`/api/lotto/number/${id}/note`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({note: newNote})
            });
            if (response.ok) {
                cell.textContent = newNote;
            } else {
                alert("메모 수정 실패");
                cell.textContent = originalNote;
            }
        } catch (err) {
            alert("에러 발생: " + err.message);
            cell.textContent = originalNote;
        }
    }
    function showRoundDetailDialog(lotto, rank) {
        openModal();
        modalBody.innerHTML = `
            <h3>상세 정보</h3>
            <table style="width:100%;">
                <tbody>
                    <tr>
                        <th style="text-align:left; width:150px; padding:6px; border:1px solid #ddd;">회차</th>
                        <td style="padding:6px; border:1px solid #ddd;">${lotto.times}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">등수</th>
                        <td style="padding:6px; border:1px solid #ddd;">${
            rank === null || rank === undefined ? "공개예정" : rank === 0 ? "낙첨" : rank
        }</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">공개일</th>
                        <td style="padding:6px; border:1px solid #ddd;">${lotto.openDate || "-"}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">공개여부</th>
                        <td style="padding:6px; border:1px solid #ddd;">${lotto.isOpen ? "예" : "아니오"}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">공개된 번호</th>
                        <td style="padding:6px; border:1px solid #ddd;">${
            Array.isArray(lotto.numbers) ? lotto.numbers.join(", ") : ""
        }</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">보너스번호</th>
                        <td style="padding:6px; border:1px solid #ddd;">${lotto.bonusNumber || ""}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">총 당첨금액</th>
                        <td style="padding:6px; border:1px solid #ddd;">${formatNumber(lotto.totalPrize)}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">1등 당첨금액</th>
                        <td style="padding:6px; border:1px solid #ddd;">${formatNumber(lotto.firstWinnerPrize)}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">1등 당첨자 수</th>
                        <td style="padding:6px; border:1px solid #ddd;">${lotto.winCnt || 0}</td>
                    </tr>
                    <tr>
                        <th style="text-align:left; padding:6px; border:1px solid #ddd;">1등 시 수령금액</th>
                        <td style="padding:6px; border:1px solid #ddd;">${
            lotto.winCnt > 0 ? formatNumber(lotto.firstWinnerPrize / lotto.winCnt) : 0
        }</td>
                    </tr>
                </tbody>
            </table>
        `;
    }
    function formatNumber(num) {
        if (!num || isNaN(num)) return "0";
        return num.toLocaleString("ko-KR");
    }
    function formatNumbers(inputNumbers, winningNumbers) {
        if (!winningNumbers || !Array.isArray(winningNumbers)) {
            winningNumbers = [];
        }
        const winningSet = new Set(winningNumbers.map(num => parseInt(num, 10)));
        return inputNumbers.map(num => {
            const val = parseInt(num, 10);
            const display = val.toString().padStart(2, " ");
            return winningSet.has(val)
                ? `<span style="color:#00ab00; font-weight:bold">${display}</span>`
                : `<span>${display}</span>`;
        }).join(" ");
    }

    /* 버튼 중복 클릭 방지 */
    function handleButtonClick(button, callback) {
        if (button.disabled) return;
        button.disabled = true;
        button.classList.add("disabled");
        const result = callback();
        if (result instanceof Promise) {
            result.finally(() => {
                button.disabled = false;
                button.classList.remove("disabled");
            });
        } else {
            button.disabled = false;
            button.classList.remove("disabled");
        }
    }

    /* 번호 생성 */
    const btnGenerateNumbers = document.getElementById("btn-generate-numbers");
    btnGenerateNumbers.addEventListener("click", async () => {
        handleButtonClick(btnGenerateNumbers, async () => {
            openModal();
            const algos = await fetchAlgorithms();
            showGenerateDialog(algos);
        });
    });
    async function fetchAlgorithms() {
        if (algorithms !== null) return algorithms;
        const response = await fetch("/api/config/number/build/algorithms");
        algorithms = await response.json();
        return algorithms;
    }
    function showGenerateDialog(algorithms) {
        modalBody.innerHTML = `
            <h3>번호 생성</h3>
            <div class="gen-form">
                <div class="gen-field">
                    <label>생성 개수 (최대 20)</label>
                    <input type="number" id="countInput" min="1" max="20" value="1" />
                </div>
                <div class="gen-field">
                    <label>알고리즘 선택</label>
                    <select id="algorithmDropdown">
                        ${algorithms.map(algo => `
                            <option value="${algo.key}" data-desc="${algo.description}">${algo.value}</option>
                        `).join("")}
                    </select>
                    <div style="font-size:12px; color:#555;" id="algorithmDescription"></div>
                </div>
            </div>
            <div id="algorithmDetails" style="margin-top:8px;"></div>
            <div class="dialog-button-row">
                <button class="dialog-button btn-cancel" onclick="closeModal()">취소</button>
                <button class="dialog-button btn-submit" id="btn-generate" disabled>생성</button>
            </div>
        `;
        const algorithmDropdown = document.getElementById("algorithmDropdown");
        const algorithmDescription = document.getElementById("algorithmDescription");
        const btnGenerate = document.getElementById("btn-generate");
        const defaultOption = algorithmDropdown.options[algorithmDropdown.selectedIndex];
        algorithmDescription.textContent = defaultOption.getAttribute("data-desc") || "";
        algorithmDropdown.addEventListener("change", (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            algorithmDescription.textContent = selectedOption.getAttribute("data-desc");
            updateAlgorithmDetails(selectedOption.value);
            checkGenerateButton();
        });
        document.getElementById("countInput").addEventListener("input", checkGenerateButton);
        btnGenerate.addEventListener("click", async () => {
            const algorithm = algorithmDropdown.value;
            const count = document.getElementById("countInput").value;
            const detail = collectDetails(algorithm);
            const progressingId = crypto.randomUUID
                ? crypto.randomUUID()
                : "progressingId_" + Math.random().toString(36).substr(2, 12);
            const eventSource = new EventSource(`/api/progressing/${progressingId}`);
            modalBody.innerHTML = `
                <h3>번호 생성 진행 중</h3>
                <div id="progressInfo" style="font-size:12px; color:gray; margin-bottom:8px;">0% (0/0) |</div>
                <div style="width:100%; background-color:#e0e0e0; border-radius:4px;">
                    <div id="progressBar" style="width:0%; height:20px; background-color:#4caf50; border-radius:4px;"></div>
                </div>
            `;
            eventSource.addEventListener("processing_info", (event) => {
                const data = JSON.parse(event.data);
                const {percent, executeCnt, totalCnt, description} = data;
                document.getElementById("progressInfo").textContent = `${percent}% (${executeCnt}/${totalCnt}) | ${description}`;
                document.getElementById("progressBar").style.width = percent + "%";
            });
            eventSource.addEventListener("processing_success_info", () => {
                eventSource.close();
                closeModal();
            });
            eventSource.onerror = () => {
                eventSource.close();
            };
            try {
                const response = await fetch("/api/lotto/numbers/build", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        algorithm,
                        cnt: parseInt(count, 10),
                        detail,
                        progressingId: progressingId,
                    }),
                });
                showGeneratedResult(await response.json());
            } catch (error) {
                alert(`에러가 발생했습니다: ${error.message}`);
                eventSource.close();
            }
        });
        updateAlgorithmDetails(algorithmDropdown.value);
        checkGenerateButton();
    }
    function updateAlgorithmDetails(algorithmKey) {
        const detailsContainer = document.getElementById("algorithmDetails");
        detailsContainer.innerHTML = "";
        if (algorithmKey === "METAHEURISTIC") {
            detailsContainer.innerHTML = `
                <div>
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput"/>
                </div>
                <div>
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput"/>
                </div>
            `;
        } else if (algorithmKey === "GENETIC") {
            detailsContainer.innerHTML = `
                <div>
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput"/>
                </div>
                <div>
                    <label>세대 수 (10~50)</label>
                    <input type="number" min="10" max="50" value="30" id="generationsInput"/>
                </div>
                <div>
                    <label>돌연변이 비율 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.05" id="mutationRateInput"/>
                </div>
                <div>
                    <label>염색체 개수 (5~20)</label>
                    <input type="number" min="5" max="20" value="10" id="populationSizeInput"/>
                </div>
                <div>
                    <label>교차율 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.5" id="crossoverRateInput"/>
                </div>
                <div>
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput"/>
                </div>
            `;
        } else if (algorithmKey === "APRIORI") {
            detailsContainer.innerHTML = `
                <div>
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput"/>
                </div>
                <div>
                    <label>최소 지지도 (1~10)</label>
                    <input type="number" min="1" max="10" value="3" id="minSupportCntInput"/>
                </div>
                <div>
                    <label>최소 신뢰도 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.6" id="minConfidenceInput"/>
                </div>
                <div>
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput"/>
                </div>
            `;
        }
    }
    function collectDetails(algorithmKey) {
        const detail = {};
        if (["METAHEURISTIC","GENETIC","APRIORI"].includes(algorithmKey)) {
            detail.rangeRate = parseFloat(document.getElementById("rangeRateInput").value) || 0;
            const timesBefore = document.getElementById("timesBeforeInput").value;
            if (timesBefore) detail.timesBefore = parseInt(timesBefore, 10);
        }
        if (algorithmKey === "GENETIC") {
            detail.generations = parseInt(document.getElementById("generationsInput").value, 10);
            detail.mutationRate = parseFloat(document.getElementById("mutationRateInput").value);
            detail.populationSize = parseInt(document.getElementById("populationSizeInput").value, 10);
            detail.crossoverRate = parseFloat(document.getElementById("crossoverRateInput").value);
        }
        if (algorithmKey === "APRIORI") {
            detail.minSupportCnt = parseInt(document.getElementById("minSupportCntInput").value, 10);
            detail.minConfidence = parseFloat(document.getElementById("minConfidenceInput").value);
        }
        return detail;
    }
    function showGeneratedResult(result) {
        modalBody.innerHTML = "<h3>생성된 번호</h3>";
        const generatedNumbersList = result.map(item => item.numbers);
        const table = document.createElement("table");
        table.innerHTML = `
            <thead>
                <tr><th>번호</th></tr>
            </thead>
            <tbody>
                ${generatedNumbersList.map(nums => `<tr><td>${nums.join(", ")}</td></tr>`).join("")}
            </tbody>
        `;
        modalBody.appendChild(table);
        const buttonRow = document.createElement("div");
        buttonRow.className = "dialog-button-row";
        buttonRow.innerHTML = `
            <button class="dialog-button btn-cancel" id="btnCloseGenerate">닫기</button>
            <button class="dialog-button btn-submit" id="btnRegisterGenerated">등록</button>
        `;
        modalBody.appendChild(buttonRow);
        document.getElementById("btnCloseGenerate").addEventListener("click", () => {
            closeModal();
        });
        document.getElementById("btnRegisterGenerated").addEventListener("click", () => {
            closeModal();
            openModal();
            showNumberRegisterScreen(generatedNumbersList);
        });
    }

    /* QR 인식 */
    const btnReadQr = document.getElementById("btn-read-qr");
    btnReadQr.addEventListener("click", () => {
        showQrDialog();
    });
    function showQrDialog() {
        openModal();
        modalBody.innerHTML = `
            <h3 style="text-align:center;">QR 코드 인식</h3>
            <div style="text-align:center; margin-top:20px;">
                <button id="qrUploadButton" class="btn" style="font-size:16px; margin:0 10px;">업로드</button>
                <button id="qrCameraButton" class="btn" style="font-size:16px; margin:0 10px;">촬영</button>
            </div>
            <input type="file" id="qrFileInput" accept="image/*" style="display:none;">
            <div id="qrReader" style="display:none; margin:20px auto;"></div>
            <div id="qrResult" style="text-align:center; margin-top:20px;"></div>
        `;
        document.getElementById("qrUploadButton").addEventListener("click", () => {
            document.getElementById("qrFileInput").click();
        });
        document.getElementById("qrFileInput").addEventListener("change", handleQrFileUpload);
        document.getElementById("qrCameraButton").addEventListener("click", startQrCamera);
    }
    function handleQrFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const qrCodeReader = new Html5Qrcode("qrReader");
        qrCodeReader.scanFile(file, true)
            .then(decodedText => {
                processQrResult(decodedText);
                qrCodeReader.clear();
            })
            .catch(err => {
                alert("QR 코드 인식 실패: " + err);
            });
    }
    function startQrCamera() {
        document.getElementById("qrReader").style.display = "block";
        Html5Qrcode.getCameras()
            .then(cameras => {
                if (cameras && cameras.length) {
                    camerasList = cameras;
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    let preferredCamera = null;
                    if (isMobile) {
                        preferredCamera = cameras.find(cam => cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("rear"));
                    } else {
                        preferredCamera = cameras.find(cam => cam.label.toLowerCase().includes("front") || cam.label.toLowerCase().includes("user"));
                    }
                    if (!preferredCamera) {
                        preferredCamera = cameras[0];
                    }
                    currentCameraIndex = cameras.indexOf(preferredCamera);
                    startScanningWithCamera(preferredCamera.id);
                } else {
                    alert("사용 가능한 카메라가 없습니다.");
                }
            })
            .catch(err => {
                alert("카메라 접근 오류: " + err);
            });
    }
    function startScanningWithCamera(cameraId) {
        html5QrCodeInstance = new Html5Qrcode("qrReader");
        const config = { fps: 10, qrbox: 250 };
        html5QrCodeInstance.start(cameraId, config, (decodedText) => {
            processQrResult(decodedText);
            html5QrCodeInstance.stop().then(() => {
                document.getElementById("qrReader").innerHTML = "";
                document.getElementById("qrReader").style.display = "none";
                html5QrCodeInstance = null;
            });
        }).catch(err => {
            alert("카메라 시작 실패: " + err);
        });
        if (camerasList.length > 1) {
            let switchBtn = document.getElementById("switchCameraBtn");
            if (!switchBtn) {
                switchBtn = document.createElement("button");
                switchBtn.id = "switchCameraBtn";
                switchBtn.textContent = "카메라 전환";
                switchBtn.className = "btn";
                switchBtn.style.marginTop = "10px";
                switchBtn.addEventListener("click", switchCamera);
                document.getElementById("qrReader").appendChild(switchBtn);
            }
        }
    }
    function switchCamera() {
        if (!camerasList || camerasList.length < 2) return;
        if (html5QrCodeInstance) {
            html5QrCodeInstance.stop().then(() => {
                html5QrCodeInstance.clear();
                html5QrCodeInstance = null;
                currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;
                const newCamera = camerasList[currentCameraIndex];
                startScanningWithCamera(newCamera.id);
            });
        }
    }
    function processQrResult(url) {
        fetch("/api/lotto/url/decode", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({url}),
        })
            .then(response => {
                if (response.status === 400) {
                    return response.json().then(data => {
                        alert(data.message);
                        showQrDialog();
                        throw new Error(data.message);
                    });
                } else if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("서버 에러 발생");
                }
            })
            .then(data => {
                closeModal();
                openModal();
                const defaultTimes = data.length > 0 ? data[0].times : null;
                const numbersList = data.map(item => item.numbers);
                showNumberRegisterScreen(numbersList, defaultTimes);
            })
            .catch(err => {
                console.log(err);
            });
    }
</script>
</body>
</html>
