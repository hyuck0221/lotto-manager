<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LOTTO MANAGER - hshim</title>
    <!-- html5-qrcode 라이브러리 (카메라 관련) -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* 리셋 및 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f9f9f9;
            padding-top: 60px;
            color: #333;
        }

        button,
        input,
        select,
        textarea {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            transition: border-color 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4caf50;
        }

        #timesInput {
            width: 120px;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* 헤더 영역 */
        .header {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ccc;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            margin-left: 8px;
        }

        .display-name {
            font-size: 14px;
            font-weight: 600;
        }

        /* 사용자 프로필 드롭다운 */
        .dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            min-width: 90px;
        }

        .dropdown button {
            background: none;
            border: none;
            padding: 8px 16px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown button:hover {
            background-color: #f5f5f5;
        }

        .dropdown.open {
            display: flex;
        }

        /* 컨테이너 영역 */
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        /* 모던한 메인 버튼 그리드 (2행 2열) */
        .main-button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .main-button {
            display: none; /* 이미지 로드 전에는 버튼 숨김 */
            border: none;
            border-radius: 8px;
            padding: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .main-button:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
        }

        .main-button:disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .main-button img {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            display: none; /* 로드 전에는 숨김 */
        }

        .main-button.loaded {
            display: flex; /* 이미지가 로드되면 버튼 표시 */
        }

        /* 이미지 로드 완료 시 부모에 loaded 클래스 추가 */
        .main-button.loaded img {
            display: block;
        }

        /* 모달 영역 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 16px;
        }

        .modal-content {
            background-color: #fff;
            position: relative;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 16px;
        }

        .modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .header {
                padding: 8px 16px;
            }

            .main-button {
                padding: 15px;
                font-size: 14px;
            }
        }

        /* 기타 기존 스타일 (테이블, 폼 등) 은 그대로 유지 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            margin-bottom: 16px;
            background-color: #fff;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }

        th {
            background-color: #f7f7f7;
        }

        .footer-info {
            margin-top: 32px;
            padding: 20px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
        }

        .footer-info p {
            margin: 4px 0;
        }

        .footer-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .footer-link {
            color: #0066cc;
            text-decoration: none;
        }

        .btn-round-detail {
            background-color: #2196f3;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-round-detail:hover {
            background-color: #1e88e5;
            transform: translateY(-1px);
        }

        .btn-delete {
            background-color: #f44336;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-delete:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }

        .lotto-number-input {
            width: 50px;
            padding: 6px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-plus, .btn-minus {
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            padding: 4px 12px; /* 기존보다 크게 */
            font-size: 15px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-plus {
            background-color: #2196f3;
        }

        .btn-plus:hover {
            background-color: #1e88e5;
            transform: translateY(-1px);
        }

        .btn-minus {
            background-color: #f44336;
        }

        .btn-minus:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }

        .dialog-button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-cancel {
            background-color: #bbb;
            color: #fff;
        }

        .btn-cancel:hover {
            background-color: #a6a6a6;
            transform: translateY(-1px);
        }

        .btn-submit {
            background-color: #4caf50;
            color: #fff;
        }

        .btn-submit:hover {
            background-color: #43a047;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
<div class="header">
    <div id="headerLeft" style="font-weight: bold;"></div>
    <div class="user-info" id="user-info">
        <div class="profile-img" id="profile-img">
            <img id="profile-image" src="" alt=""/>
        </div>
        <div class="user-details">
            <div class="display-name" id="display-name"></div>
        </div>
        <div class="dropdown" id="dropdown">
            <button id="my-info">내 정보</button>
            <button id="question">문의</button>
            <button id="notice">공지사항</button>
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit">로그아웃</button>
            </form>
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 10px; font-size: 14px; color: #555;">
    매주 토요일 오후 9시 이메일로 결과를 정리하여 보내드립니다
</div>

<div class="container">
    <!-- 모던한 4개의 메인 버튼 (2행 2열) -->
    <div class="main-button-grid">
        <button class="main-button" id="btn-game">
            <img id="img-game" src="/icon/main-button/game.png" alt="게임"/>
            <span>게임</span>
        </button>
        <button class="main-button" id="btn-register-numbers">
            <img id="img-register" src="/icon/main-button/register-number.png" alt="번호 등록"/>
            <span>번호 등록</span>
        </button>
        <button class="main-button" id="btn-generate-numbers">
            <img id="img-generate" src="/icon/main-button/random-number.png" alt="번호 생성"/>
            <span>번호 생성</span>
        </button>
        <button class="main-button" id="btn-read-qr">
            <img id="img-readqr" src="/icon/main-button/read-qr.png" alt="QR 인식"/>
            <span>QR 인식</span>
        </button>
    </div>

    <!-- 등록된 로또 번호 목록 -->
    <div class="registered-lotto-container" id="registeredLottoContainer"></div>
</div>

<!-- 모달 영역 -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose">X</button>
        <div id="modalBody"></div>
    </div>
</div>

<div class="footer-info">
    <div class="footer-title">문의 및 정보</div>
    <p>이메일 문의: <a href="mailto:hshim.universe@gmail.com" class="footer-link">hshim.universe@gmail.com</a></p>
    <p>인스타그램: <a href="https://instagram.com/hshim__" target="_blank" class="footer-link">@hshim__</a></p>
</div>

<script>
    /* ----------------------------
       공통 모달 관련 함수
    ---------------------------- */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalClose = document.getElementById("modalClose");
    const modalBody = document.getElementById("modalBody");

    function openModal() {
        modalOverlay.style.display = "flex";
    }

    function closeModal() {
        if (html5QrCodeInstance) {
            html5QrCodeInstance.stop().then(() => {
                html5QrCodeInstance.clear();
                html5QrCodeInstance = null;
            }).catch((err) => {
                if (err && err.message && err.message.indexOf("not running") !== -1) {
                    // 이미 종료된 경우 초기화 처리
                    html5QrCodeInstance.clear();
                    html5QrCodeInstance = null;
                } else {
                    console.error("카메라 종료 중 오류 발생:", err);
                }
            });
        }
        modalOverlay.style.display = "none";
        modalBody.innerHTML = "";
    }

    modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });
    modalClose.addEventListener("click", closeModal);

    /* ----------------------------
       사용자 정보 및 드롭다운
    ---------------------------- */
    const userInfo = document.getElementById("user-info");
    const dropdown = document.getElementById("dropdown");
    const myInfo = document.getElementById("my-info");
    const question = document.getElementById("question");
    const notice = document.getElementById("notice");
    let userId = null;
    userInfo.addEventListener("click", () => {
        dropdown.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
        if (!userInfo.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.remove("open");
        }
    });
    myInfo.addEventListener("click", () => {
        location.href = "/page/account/user/my-info";
    });
    question.addEventListener("click", () => {
        location.href = "/page/question/list";
    });
    notice.addEventListener("click", () => {
        location.href = "/page/notice/list";
    });

    window.addEventListener("DOMContentLoaded", async () => {
        fetchUserInfo();
        fetchCurrentTimes();
        loadRegisteredLottoNumbers();
        document.querySelectorAll(".main-button img").forEach((img) => {
            const showButton = () => {
                img.parentElement.classList.add("loaded");
            };
            img.addEventListener("load", showButton);
            img.addEventListener("error", showButton);
        });
    });

    async function fetchUserInfo() {
        const response = await fetch("/api/account/user/my-info");
        if (response.ok) {
            const user = await response.json();
            userId = user.id;
            const profileImg = document.getElementById("profile-image");
            const displayName = document.getElementById("display-name");
            displayName.textContent = user.displayName;
            if (user.profileUrl) {
                profileImg.src = user.profileUrl;
                profileImg.style.backgroundColor = "transparent";
            } else {
                profileImg.src =
                    "https://cdn-icons-png.flaticon.com/512/747/747545.png";
                profileImg.style.backgroundColor = "#ccc";
            }
        }
    }

    function initializeImageLoading() {
        document.querySelectorAll(".main-button img").forEach((img) => {
            // 이미지가 이미 로드 완료된 상태라면 바로 처리
            if (img.complete) {
                img.parentElement.classList.add("loaded");
            } else {
                const showButton = () => {
                    img.parentElement.classList.add("loaded");
                };
                img.addEventListener("load", showButton);
                img.addEventListener("error", showButton);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initializeImageLoading);
    window.addEventListener("pageshow", initializeImageLoading);

    /* ----------------------------
       기존 로또 관련 기능 (게임, 번호 등록, 번호 생성)
    ---------------------------- */
    const btnGame = document.getElementById("btn-game");
    btnGame.addEventListener("click", () => {
        window.location.href = "/page/game/main";
    });

    const btnRegisterNumbers = document.getElementById("btn-register-numbers");
    btnRegisterNumbers.addEventListener("click", () => {
        handleButtonClick(btnRegisterNumbers, () => {
            openModal();
            showNumberRegisterScreen();
        });
    });

    let lottoRows = [];

    async function showNumberRegisterScreen(initialNumbersList = [], defaultTimes = null) {
        modalBody.innerHTML = `
    <h3>번호 등록</h3>
    <div>
      <label>회차: </label>
      <input type="number" id="timesInput" class="lotto-times-input" value="" style="width:120px;" />
    </div>
    <div id="lottoRowsContainer" style="margin: 16px 0;"></div>
  `;

        // 로또 번호 입력 행 초기화
        lottoRows = [];
        if (initialNumbersList.length > 0) {
            initialNumbersList.forEach(numbers => addLottoRow(numbers));
        } else {
            addLottoRow();
        }

        const buttonRow = document.createElement("div");
        buttonRow.className = "dialog-button-row";
        buttonRow.innerHTML = `
    <button class="dialog-button btn-submit" id="btnSubmitManual" disabled>등록</button>
  `;
        modalBody.appendChild(buttonRow);
        document.getElementById("btnSubmitManual").addEventListener("click", () => {
            const btn = document.getElementById("btnSubmitManual");
            handleButtonClick(btn, () => submitManualNumbers());
        });
        modalBody.addEventListener("input", checkAllInputsFilled);

        // defaultTimes 값이 전달되면 해당 값으로 회차 입력란을 채우고,
        // 없을 경우 기존 로직대로 최신 회차를 가져옵니다.
        if (defaultTimes !== null) {
            document.getElementById("timesInput").value = defaultTimes;
            checkAllInputsFilled();
        } else {
            try {
                const res = await fetch("/api/lotto/times/latest");
                if (!res.ok) throw new Error("서버 응답이 정상이 아닙니다.");
                const data = await res.json();
                const nextTimes = data.times + 1;
                const timesInputEl = document.getElementById("timesInput");
                timesInputEl.value = nextTimes;
                checkAllInputsFilled();
            } catch (err) {
                console.error("회차 조회 오류:", err.message);
                document.getElementById("timesInput").value = 1;
                checkAllInputsFilled();
            }
        }
    }


    function addLottoRow(preFilledNumbers = []) {
        const container = document.getElementById("lottoRowsContainer");
        const rowIndex = lottoRows.length;
        const rowId = `lottoRow_${rowIndex}`;
        const div = document.createElement("div");
        div.className = "lotto-input-row";
        div.id = rowId;
        let inputHtml = "";
        for (let i = 0; i < 6; i++) {
            const numberValue =
                preFilledNumbers[i] !== undefined ? preFilledNumbers[i] : "";
            inputHtml += `<input
                type="number"
                class="lotto-number-input"
                value="${numberValue}"
            />`;
        }
        if (rowIndex === 0) {
            div.innerHTML = `
                ${inputHtml}
                <button class="btn-plus" id="btnPlus_${rowIndex}">+</button>
            `;
        } else {
            div.innerHTML = `
                ${inputHtml}
                <button class="btn-plus" id="btnPlus_${rowIndex}">+</button>
                <button class="btn-minus" id="btnMinus_${rowIndex}">-</button>
            `;
        }
        container.appendChild(div);
        lottoRows.push(rowId);
        document.getElementById(`btnPlus_${rowIndex}`).addEventListener("click", () => {
            addLottoRow();
        });
        if (rowIndex > 0) {
            document.getElementById(`btnMinus_${rowIndex}`).addEventListener("click", () => {
                removeLottoRow(rowId);
            });
        }
        checkAllInputsFilled();
    }

    function removeLottoRow(rowId) {
        const div = document.getElementById(rowId);
        if (div) {
            div.remove();
        }
        lottoRows = lottoRows.filter((id) => id !== rowId);
        checkAllInputsFilled();
    }

    function checkAllInputsFilled() {
        const timesInput = document.getElementById("timesInput");
        if (!timesInput) return;
        const btnSubmitManual = document.getElementById("btnSubmitManual");
        if (!btnSubmitManual) return;
        const timesValue = timesInput.value.trim();
        const numbersInputs = modalBody.querySelectorAll(".lotto-number-input");
        if (!timesValue) {
            btnSubmitManual.disabled = true;
            return;
        }
        for (let input of numbersInputs) {
            if (!input.value.trim()) {
                btnSubmitManual.disabled = true;
                return;
            }
        }
        btnSubmitManual.disabled = false;
    }

    function submitManualNumbers() {
        const timesValue = document.getElementById("timesInput").value.trim();
        const requestData = [];
        lottoRows.forEach((rowId) => {
            const rowDiv = document.getElementById(rowId);
            if (rowDiv) {
                const inputs = rowDiv.querySelectorAll(".lotto-number-input");
                const numbers = [];
                inputs.forEach((inp) => {
                    numbers.push(parseInt(inp.value.trim(), 10));
                });
                requestData.push({
                    times: parseInt(timesValue, 10),
                    numbers: numbers,
                });
            }
        });
        fetch("/api/lotto/numbers", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(requestData),
        })
            .then((res) => {
                if (res.status === 400) {
                    res.json().then((data) => {
                        alert(data.message);
                    });
                } else {
                    alert("등록되었습니다");
                    closeModal();
                    loadRegisteredLottoNumbers();
                }
            })
            .catch((err) => {
                alert("에러가 발생했습니다: " + err.message);
            });
    }

    const registeredLottoContainer = document.getElementById("registeredLottoContainer");

    function loadRegisteredLottoNumbers() {
        fetch("/api/lotto/numbers", {method: "GET"})
            .then((res) => {
                if (!res.ok) throw new Error("서버 응답이 정상이 아닙니다");
                return res.json();
            })
            .then((data) => {
                if (!Array.isArray(data) || data.length === 0) {
                    registeredLottoContainer.innerHTML = `<p>등록된 로또 번호가 없습니다.</p>`;
                    return;
                }
                renderRegisteredLottoList(data);
            })
            .catch((err) => {
                alert("에러가 발생했습니다: " + err.message);
            });
    }

    function renderRegisteredLottoList(list) {
        const groupedByTimes = {};
        list.forEach((item) => {
            const timesKey = item.lotto.times;
            if (!groupedByTimes[timesKey]) {
                groupedByTimes[timesKey] = [];
            }
            groupedByTimes[timesKey].push(item);
        });
        const sortedTimes = Object.keys(groupedByTimes).sort(
            (a, b) => parseInt(b, 10) - parseInt(a, 10)
        );
        let html = "";
        sortedTimes.forEach((times) => {
            const items = groupedByTimes[times];
            const referenceItem = items[0];
            const lottoInfo = referenceItem.lotto || {};
            const winningNumbersStr = Array.isArray(lottoInfo.numbers)
                ? lottoInfo.numbers.join(", ")
                : "";
            const bonusStr =
                lottoInfo.bonusNumber != null ? ` + ${lottoInfo.bonusNumber}` : "";
            html += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px;">
                <h4 style="margin: 0;">
                    ${times} 회차
                    <button class="btn-round-detail"
                        data-lotto='${JSON.stringify(lottoInfo)}'
                        data-rank='${referenceItem.rank}'
                    >상세</button>
                    <span style="margin-left: 12px; font-weight: normal; font-size: 14px;">
                       ${winningNumbersStr}${bonusStr}
                    </span>
                </h4>
            </div>
            <table style="margin-top: 8px; width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 200px;">입력번호</th>
                        <th style="width: 100px;">등수</th>
                        <th style="width: 80px;">삭제</th>
                    </tr>
                </thead>
                <tbody>
        `;
            items.forEach((item) => {
                let displayRank = item.rank;
                if (item.rank === null || item.rank === undefined) {
                    displayRank = "공개예정";
                } else if (item.rank === 0) {
                    displayRank = "낙첨";
                }
                const deleteButtonHtml = `<button class="btn-delete" data-id="${item.id}">삭제</button>`;
                const inputNumbersHtml = formatNumbers(
                    item.numbers || [],
                    lottoInfo.numbers || []
                );
                html += `
                <tr>
                    <td style="font-family: monospace;">${inputNumbersHtml}</td>
                    <td>${displayRank}</td>
                    <td>${deleteButtonHtml}</td>
                </tr>
            `;
            });
            html += `
                </tbody>
            </table>
        `;
        });
        if (!list || list.length === 0) {
            html = "<p>등록된 로또 번호가 없습니다.</p>";
        }
        registeredLottoContainer.innerHTML = html;
        const deleteButtons = registeredLottoContainer.querySelectorAll(".btn-delete");
        deleteButtons.forEach((btn) => {
            btn.addEventListener("click", async () => {
                const id = btn.getAttribute("data-id");
                if (!confirm("정말 삭제하시겠습니까?")) return;
                try {
                    const response = await fetch(`/api/lotto/number/${id}`, {method: "DELETE"});
                    if (response.ok) {
                        alert("삭제되었습니다.");
                        loadRegisteredLottoNumbers();
                    } else {
                        alert("삭제 실패했습니다.");
                    }
                } catch (err) {
                    alert("에러가 발생했습니다: " + err.message);
                }
            });
        });
        const detailButtons = registeredLottoContainer.querySelectorAll(".btn-round-detail");
        detailButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const lottoStr = btn.getAttribute("data-lotto");
                const rankStr = btn.getAttribute("data-rank");
                if (!lottoStr) return;
                const lottoObj = JSON.parse(lottoStr);
                const rankVal =
                    rankStr !== "null" && rankStr !== "undefined" ? parseInt(rankStr, 10) : null;
                showRoundDetailDialog(lottoObj, rankVal);
            });
        });
    }

    function showRoundDetailDialog(lotto, rank) {
        openModal();
        modalBody.innerHTML = `
        <h3>상세 정보</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tbody>
                <tr>
                    <th style="text-align: left; width: 150px; padding: 6px; border: 1px solid #ddd;">회차</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${lotto.times}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">등수</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">
                        ${
            rank === null || rank === undefined
                ? "공개예정"
                : rank === 0
                    ? "낙첨"
                    : rank
        }
                    </td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">공개일</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${lotto.openDate || "-"}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">공개여부</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${lotto.isOpen ? "예" : "아니오"}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">공개된 번호</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">
                        ${
            Array.isArray(lotto.numbers)
                ? lotto.numbers.join(", ")
                : ""
        }
                    </td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">보너스번호</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${lotto.bonusNumber || ""}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">총 당첨금액</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${formatNumber(lotto.totalPrize)}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">1등 당첨금액</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${formatNumber(lotto.firstWinnerPrize)}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">1등 당첨자 수</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">${lotto.winCnt || 0}</td>
                </tr>
                <tr>
                    <th style="text-align: left; padding: 6px; border: 1px solid #ddd;">1등 시 수령금액</th>
                    <td style="padding: 6px; border: 1px solid #ddd;">
                        ${
            lotto.winCnt > 0
                ? formatNumber(lotto.firstWinnerPrize / lotto.winCnt)
                : 0
        }
                    </td>
                </tr>
            </tbody>
        </table>
      `;
    }

    function formatNumber(num) {
        if (!num || isNaN(num)) {
            return "0";
        }
        return num.toLocaleString("ko-KR");
    }

    function formatNumbers(inputNumbers, winningNumbers) {
        if (!winningNumbers || !Array.isArray(winningNumbers)) {
            winningNumbers = [];
        }
        const winningSet = new Set(winningNumbers.map((num) => parseInt(num, 10)));
        return inputNumbers
            .map((num) => {
                const val = parseInt(num, 10);
                const display = val.toString().padStart(2, " ");
                return winningSet.has(val)
                    ? `<span style="color: #00ab00; font-weight: bold">${display}</span>`
                    : `<span>${display}</span>`;
            })
            .join(" ");
    }

    /* ----------------------------
       버튼 중복 클릭 방지 유틸
    ---------------------------- */
    function handleButtonClick(button, callback) {
        if (button.disabled) return;
        button.disabled = true;
        button.classList.add("disabled");
        const result = callback();
        if (result instanceof Promise) {
            result.finally(() => {
                button.disabled = false;
                button.classList.remove("disabled");
            });
        } else {
            button.disabled = false;
            button.classList.remove("disabled");
        }
    }

    /* ----------------------------
       번호 생성 관련
    ---------------------------- */
    const btnGenerateNumbers = document.getElementById("btn-generate-numbers");
    btnGenerateNumbers.addEventListener("click", async () => {
        handleButtonClick(btnGenerateNumbers, async () => {
            openModal();
            const algorithms = await fetchAlgorithms();
            showGenerateDialog(algorithms);
        });
    });

    async function fetchAlgorithms() {
        const response = await fetch("/api/config/number/build/algorithms");
        return response.ok ? await response.json() : [];
    }

    function showGenerateDialog(algorithms) {
        modalBody.innerHTML = `
            <h3>번호 생성</h3>
            <div class="gen-form">
                <div class="gen-field">
                    <label for="countInput" class="gen-label">생성 개수 (최대 20)</label>
                    <input type="number" id="countInput" min="1" max="20" value="1" class="gen-input"/>
                </div>
                <div class="gen-field">
                    <label for="algorithmDropdown" class="gen-label">알고리즘 선택</label>
                    <select id="algorithmDropdown" class="algorithm-select gen-input">
                        ${algorithms
            .map(
                (algo) => `
                            <option value="${algo.key}" data-desc="${algo.description}">${algo.value}</option>
                        `
            )
            .join("")}
                    </select>
                    <div class="small-text" id="algorithmDescription"></div>
                </div>
            </div>
            <div id="algorithmDetails" class="gen-details"></div>
            <div class="dialog-button-row" style="margin-top: 16px;">
                <button class="dialog-button btn-cancel" onclick="closeModal()">취소</button>
                <button class="dialog-button btn-submit" id="btn-generate" disabled>생성</button>
            </div>
        `;
        const algorithmDropdown = document.getElementById("algorithmDropdown");
        const algorithmDescription = document.getElementById("algorithmDescription");
        const btnGenerate = document.getElementById("btn-generate");
        const defaultOption = algorithmDropdown.options[algorithmDropdown.selectedIndex];
        algorithmDescription.textContent = defaultOption.getAttribute("data-desc") || "";
        algorithmDropdown.addEventListener("change", (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            algorithmDescription.textContent = selectedOption.getAttribute("data-desc");
            updateAlgorithmDetails(selectedOption.value);
            checkGenerateButton();
        });
        document.getElementById("countInput").addEventListener("input", checkGenerateButton);

        function checkGenerateButton() {
            const count = document.getElementById("countInput").value;
            btnGenerate.disabled =
                !count || count < 1 || count > 20 || !algorithmDropdown.value;
        }

        btnGenerate.addEventListener("click", async () => {
            // 1. 기존 입력 필드에서 값을 먼저 추출합니다.
            const algorithm = algorithmDropdown.value;
            const count = document.getElementById("countInput").value;
            const detail = collectDetails(algorithm);

            // 2. UUID 생성 (최신 브라우저에서는 crypto.randomUUID() 사용 가능)
            const progressingId = crypto.randomUUID ? crypto.randomUUID() : 'progressingId_' + Math.random().toString(36).substr(2, 12);

            // 3. SSE 연결: /api/progressing/{uuid} 엔드포인트에 연결
            const eventSource = new EventSource(`/api/progressing/${progressingId}`);

            // 4. 모달에 프로그레스바 UI로 교체 (입력 필드 대신 진행 상태 표시)
            modalBody.innerHTML = `
        <h3>번호 생성 진행 중</h3>
        <div id="progressInfo" style="font-size: 12px; color: gray; margin-bottom: 8px;">
            0% (0/0) |
        </div>
        <div style="width: 100%; background-color: #e0e0e0; border-radius: 4px;">
            <div id="progressBar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 4px;"></div>
        </div>
    `;

            // 5. SSE 이벤트 리스너 등록
            eventSource.addEventListener("processing_info", (event) => {
                const data = JSON.parse(event.data);
                const {percent, executeCnt, totalCnt, description} = data;
                document.getElementById("progressInfo").textContent = `${percent}% (${executeCnt}/${totalCnt}) | ${description}`;
                document.getElementById("progressBar").style.width = percent + "%";
            });

            eventSource.addEventListener("processing_success_info", (event) => {
                console.log("processing_success_info 이벤트 수신:", event);
                eventSource.close();  // 연결 종료
                closeModal();         // 모달 닫기 또는 다른 화면 전환 로직 실행
            });

            eventSource.onerror = (err) => {
                eventSource.close();
            };

            // 6. 번호 생성 API 호출 (progressingId 포함)
            try {
                const response = await fetch("/api/lotto/numbers/build", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        algorithm,
                        cnt: parseInt(count, 10),
                        detail,
                        progressingId: progressingId,
                    }),
                });
                showGeneratedResult(await response.json());
            } catch (error) {
                alert(`에러가 발생했습니다: ${error.message}`);
                eventSource.close();
            }
        });
        updateAlgorithmDetails(algorithmDropdown.value);
        checkGenerateButton();
    }

    function updateAlgorithmDetails(algorithmKey) {
        const detailsContainer = document.getElementById("algorithmDetails");
        detailsContainer.innerHTML = "";
        if (algorithmKey === "METAHEURISTIC") {
            detailsContainer.innerHTML = `
                <div class="input-group">
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput" />
                </div>
                <div class="input-group">
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput" placeholder="마지막 회차"/>
                </div>
            `;
        } else if (algorithmKey === "GENETIC") {
            detailsContainer.innerHTML = `
                <div class="input-group">
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput"/>
                </div>
                <div class="input-group">
                    <label>세대 수 (10~50)</label>
                    <input type="number" min="10" max="50" value="30" id="generationsInput"/>
                </div>
                <div class="input-group">
                    <label>돌연변이 비율 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.05" id="mutationRateInput"/>
                </div>
                <div class="input-group">
                    <label>염색체 개수 (5~20)</label>
                    <input type="number" min="5" max="20" value="10" id="populationSizeInput"/>
                </div>
                <div class="input-group">
                    <label>교차율 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.5" id="crossoverRateInput"/>
                </div>
                <div class="input-group">
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput" placeholder="마지막 회차"/>
                </div>
            `;
        } else if (algorithmKey === "APRIORI") {
            detailsContainer.innerHTML = `
                <div class="input-group">
                    <label>탐색비율 (0~100%)</label>
                    <input type="number" min="0" max="100" value="100" id="rangeRateInput"/>
                </div>
                <div class="input-group">
                    <label>최소 지지도 (1~10)</label>
                    <input type="number" min="1" max="10" value="3" id="minSupportCntInput"/>
                </div>
                <div class="input-group">
                    <label>최소 신뢰도 (0.0~1.0)</label>
                    <input type="number" step="0.01" min="0" max="1.0" value="0.6" id="minConfidenceInput"/>
                </div>
                <div class="input-group">
                    <label>탐색 마지막 회차</label>
                    <input type="number" min="0" id="timesBeforeInput" placeholder="마지막 회차"/>
                </div>
            `;
        }
    }

    function collectDetails(algorithmKey) {
        const detail = {};
        if (algorithmKey === "METAHEURISTIC" || algorithmKey === "GENETIC" || algorithmKey === "APRIORI") {
            detail.rangeRate = parseFloat(document.getElementById("rangeRateInput").value) || 0;
            const timesBefore = document.getElementById("timesBeforeInput").value;
            if (timesBefore) detail.timesBefore = parseInt(timesBefore, 10);
        }
        if (algorithmKey === "GENETIC") {
            detail.generations = parseInt(document.getElementById("generationsInput").value, 10);
            detail.mutationRate = parseFloat(document.getElementById("mutationRateInput").value);
            detail.populationSize = parseInt(document.getElementById("populationSizeInput").value, 10);
            detail.crossoverRate = parseFloat(document.getElementById("crossoverRateInput").value);
        }
        if (algorithmKey === "APRIORI") {
            detail.minSupportCnt = parseInt(document.getElementById("minSupportCntInput").value, 10);
            detail.minConfidence = parseFloat(document.getElementById("minConfidenceInput").value);
        }
        return detail;
    }

    async function fetchCurrentTimes() {
        try {
            const response = await fetch("/api/lotto/times/latest");
            if (!response.ok) {
                throw new Error("회차 정보를 가져오지 못했습니다.");
            }
            const data = await response.json();
            const headerLeft = document.getElementById("headerLeft");
            headerLeft.textContent = `${data.times + 1} 회차 공개예정`;
        } catch (err) {
            console.error("회차 조회 에러:", err.message);
        }
    }

    function showGeneratedResult(result) {
        modalBody.innerHTML = "<h3>생성된 번호</h3>";
        const generatedNumbersList = result.map((item) => item.numbers);
        const table = document.createElement("table");
        table.innerHTML = `
            <thead>
                <tr>
                    <th>번호</th>
                </tr>
            </thead>
            <tbody>
                ${generatedNumbersList
            .map((nums) => `<tr><td>${nums.join(", ")}</td></tr>`)
            .join("")}
            </tbody>
        `;
        modalBody.appendChild(table);
        const buttonRow = document.createElement("div");
        buttonRow.className = "dialog-button-row";
        buttonRow.innerHTML = `
            <button class="dialog-button btn-cancel" id="btnCloseGenerate">닫기</button>
            <button class="dialog-button btn-submit" id="btnRegisterGenerated">등록</button>
        `;
        modalBody.appendChild(buttonRow);
        document.getElementById("btnCloseGenerate").addEventListener("click", () => {
            closeModal();
        });
        document.getElementById("btnRegisterGenerated").addEventListener("click", () => {
            closeModal();
            openModal();
            showNumberRegisterScreen(generatedNumbersList);
        });
    }

    function setLoadingState(button, isLoading, originalText) {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `<div class="spinner"></div><span>생성중...</span>`;
        } else {
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    /* ----------------------------
       QR 인식 관련 기능
    ---------------------------- */

    let camerasList = [];
    let currentCameraIndex = 0;
    let html5QrCodeInstance = null;

    // QR 인식 버튼 (상단 그리드에 추가된 btn-read-qr)
    const btnReadQr = document.getElementById("btn-read-qr");
    btnReadQr.addEventListener("click", () => {
        showQrDialog();
    });

    // 첫 화면: 중앙의 "QR 인식 시작" 버튼을 보여줌
    function showQrDialog() {
        openModal();
        modalBody.innerHTML = `
        <h3 style="text-align: center;">QR 코드 인식</h3>
        <div style="text-align: center; margin-top: 20px;">
          <button id="qrUploadButton" style="font-size: 16px; padding: 10px 20px; margin: 0 10px; border: none; border-radius: 8px; background-color: #fff; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">업로드</button>
          <button id="qrCameraButton" style="font-size: 16px; padding: 10px 20px; margin: 0 10px; border: none; border-radius: 8px; background-color: #fff; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">촬영</button>
        </div>
        <input type="file" id="qrFileInput" accept="image/*" style="display:none;">
        <div id="qrReader" style="display:none; margin: 20px auto;"></div>
        <div id="qrResult" style="text-align: center; margin-top: 20px;"></div>
      `;
        document.getElementById("qrUploadButton").addEventListener("click", () => {
            document.getElementById("qrFileInput").click();
        });
        document.getElementById("qrFileInput").addEventListener("change", handleQrFileUpload);
        document.getElementById("qrCameraButton").addEventListener("click", startQrCamera);
    }

    // 파일 업로드 방식은 기존과 동일
    function handleQrFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const qrCodeReader = new Html5Qrcode("qrReader");
        qrCodeReader
            .scanFile(file, true)
            .then((decodedText) => {
                processQrResult(decodedText);
                qrCodeReader.clear();
            })
            .catch((err) => {
                alert("QR 코드 인식 실패: " + err);
            });
    }

    // 촬영 방식: 기본적으로 모바일은 후면 카메라, 데스크탑은 전면 카메라 선택
    function startQrCamera() {
        document.getElementById("qrReader").style.display = "block";
        Html5Qrcode.getCameras()
            .then((cameras) => {
                if (cameras && cameras.length) {
                    camerasList = cameras;
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    let preferredCamera = null;
                    if (isMobile) {
                        // 모바일: 후면 카메라
                        preferredCamera = cameras.find(camera => {
                            const label = camera.label.toLowerCase();
                            return label.includes("back") || label.includes("rear");
                        });
                    } else {
                        // 데스크탑: 전면 카메라
                        preferredCamera = cameras.find(camera => {
                            const label = camera.label.toLowerCase();
                            return label.includes("front") || label.includes("user");
                        });
                    }
                    if (!preferredCamera) {
                        // 원하는 카메라를 찾지 못하면 첫 번째 카메라 사용
                        preferredCamera = cameras[0];
                    }
                    currentCameraIndex = cameras.indexOf(preferredCamera);
                    startScanningWithCamera(preferredCamera.id);
                } else {
                    alert("사용 가능한 카메라가 없습니다.");
                }
            })
            .catch((err) => {
                alert("카메라 접근 오류: " + err);
            });
    }

    // 선택된 카메라 ID로 스캔 시작, 그리고 "카메라 전환" 버튼 추가
    function startScanningWithCamera(cameraId) {
        html5QrCodeInstance = new Html5Qrcode("qrReader");
        // facingMode는 환경설정과 관계없이 전달된 카메라 ID에 따라 작동하므로 따로 지정하지 않아도 됩니다.
        const config = {fps: 10, qrbox: 250};
        html5QrCodeInstance
            .start(
                cameraId,
                config,
                (decodedText, decodedResult) => {
                    processQrResult(decodedText);
                    html5QrCodeInstance
                        .stop()
                        .then(() => {
                            document.getElementById("qrReader").innerHTML = "";
                            document.getElementById("qrReader").style.display = "none";
                            html5QrCodeInstance = null;
                        })
                        .catch((err) => {
                            if (err && err.message && err.message.indexOf("not running") !== -1) {
                                document.getElementById("qrReader").innerHTML = "";
                                document.getElementById("qrReader").style.display = "none";
                                html5QrCodeInstance = null;
                            } else {
                                console.error("카메라 종료 중 오류 발생:", err);
                            }
                        });
                },
                (errorMessage) => {
                    // 인식 중 오류 발생 시 필요한 처리
                }
            )
            .catch((err) => {
                alert("카메라 시작 실패: " + err);
            });

        // 카메라 전환 버튼 추가 (여러 대의 카메라가 있을 때)
        if (camerasList.length > 1) {
            let switchBtn = document.getElementById("switchCameraBtn");
            if (!switchBtn) {
                switchBtn = document.createElement("button");
                switchBtn.id = "switchCameraBtn";
                switchBtn.textContent = "카메라 전환";
                switchBtn.style.fontSize = "16px";
                switchBtn.style.padding = "10px 20px";
                switchBtn.style.marginTop = "10px";
                switchBtn.style.border = "none";
                switchBtn.style.borderRadius = "8px";
                switchBtn.style.backgroundColor = "#fff";
                switchBtn.style.border = "1px solid #ddd";
                switchBtn.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                switchBtn.style.cursor = "pointer";
                switchBtn.addEventListener("click", switchCamera);
                document.getElementById("qrReader").appendChild(switchBtn);
            }
        }
    }

    // 카메라 전환 함수: 현재 스캔 중인 카메라를 멈추고 다음 카메라로 전환
    function switchCamera() {
        if (!camerasList || camerasList.length < 2) return;
        if (html5QrCodeInstance) {
            html5QrCodeInstance.stop().then(() => {
                html5QrCodeInstance.clear();
                html5QrCodeInstance = null;
                currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;
                const newCamera = camerasList[currentCameraIndex];
                startScanningWithCamera(newCamera.id);
            }).catch((err) => {
                console.error("카메라 전환 중 오류 발생:", err);
            });
        }
    }

    // 인식된 URL을 API로 전달하여 번호 등록 다이얼로그를 띄움
    function processQrResult(url) {
        fetch("/api/lotto/url/decode", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({url: url}),
        })
            .then((response) => {
                if (response.status === 400) {
                    return response.json().then((data) => {
                        alert(data.message);
                        showQrDialog();
                        throw new Error(data.message);
                    });
                } else if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("서버 에러 발생");
                }
            })
            .then((data) => {
                // 응답 예시: [{ "times": 1153, "numbers": [...] }, ...]
                closeModal();
                openModal();
                const defaultTimes = data.length > 0 ? data[0].times : null;
                const numbersList = data.map((item) => item.numbers);
                showNumberRegisterScreen(numbersList, defaultTimes);
            })
            .catch((err) => {
                console.log(err);
            });
    }
</script>
</body>
</html>
